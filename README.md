# OceanBase RAG 测试

读取 PDF → 向量化存储到 OceanBase → 使用 CrewAI 的 OceanBase 工具进行查询与问答。

## 流程

1. **导入 PDF**：从 PDF 提取文本，用通义 text-embedding-v3 向量化，写入 OceanBase 表 `pdf_documents`。
2. **查询**：CrewAI 使用 `OceanBaseVectorSearchTool` 做语义检索，再由智能体基于检索结果生成答案。

## 环境

- Python >=3.10
- OceanBase（支持向量，≥ 4.3.3.0），先创建库：`CREATE DATABASE IF NOT EXISTS crewai;`
- `.env` 配置：`QWEN3_API_KEY`、`BASE_URL`（可选）、`OCEANBASE_HOST` / `OCEANBASE_PORT` / `OCEANBASE_USER` / `OCEANBASE_PASSWORD` / `OCEANBASE_DB`（见 `config/settings.py`）

## 安装

```bash
cd latest_ai_development
uv sync
# 或：pip install -e .
```

## 使用

**1. 导入 PDF 到 OceanBase**

```bash
uv run load_pdf_oceanbase
```

默认使用 `knowledge/nke-10k-2023.pdf`，建表 `pdf_documents` 并写入向量。

**2. 运行 RAG 查询**

```bash
uv tool run crewai run
# 或带问题
uv run rag_oceanbase "文档中与收入、风险相关的主要内容有哪些？"
```

**3. 一键测试（导入 + 检索 + RAG）**

```bash
uv run oceanbase_rag_scenario
```

## 项目结构

```
config/          agents.yaml, tasks.yaml, settings.py（OceanBase 等）
oceanbase_rag/   crew.py（RAG 工作流）, data_loader.py（PDF 加载/检索/load_pdf_oceanbase）, embeddings.py
main.py          入口 run / run_rag_cli / run_full_scenario_cli
```

返回结果
╭───────────────────────────────────────────────────────────── 📋 Task Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Task Completed                                                                                                                               │
│  Name:                                                                                                                                        │
│  针对用户问题「文档中与收入、风险相关的主要内容有哪些？」在文档库中做语义检索。回答需含相关原文/摘要、相似度（distance）、文档元信息。        │
│  Agent:                                                                                                                                       │
│  高级语义检索助手                                                                                                                             │
│                                                                                                                                               │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭─────────────────────────────────────────────────────────────── 📋 Task Started ───────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Task Started                                                                                                                                 │
│  Name: 在已有检索结果基础上，针对用户问题「文档中与收入、风险相关的主要内容有哪些？」生成最终答案。基于检索内容，不编造；不足则说明。         │
│  ID: 0b260b44-ec11-4e38-90d1-5a28ca2bcc62                                                                                                     │
│                                                                                                                                               │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭────────────────────────────────────────────────────────────── 🤖 Agent Started ───────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Agent: 高级问答助手                                                                                                                          │
│                                                                                                                                               │
│  Task: 在已有检索结果基础上，针对用户问题「文档中与收入、风险相关的主要内容有哪些？」生成最终答案。基于检索内容，不编造；不足则说明。         │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭──────────────────────────────────────────────────────────── ✅ Agent Final Answer ────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Agent: 高级问答助手                                                                                                                          │
│                                                                                                                                               │
│  Final Answer:                                                                                                                                │
│  文档中与收入、风险相关的主要内容包括：                                                                                                       │
│                                                                                                                                               │
│  1. **收入相关内容**：                                                                                                                        │
│     - 在“Note 14 Revenues”（第83页）中详细说明了收入的会计政策和确认方式。                                                                    │
│     -                                                                                                                                         │
│  衍生工具作为现金流量套期保值的一部分，其重分类调整影响收入。例如，外汇远期和期权在2023年有2600万美元的收益从累计其他综合收益重分类至收入（R  │
│  evenues）（见第82页表格）。                                                                                                                  │
│                                                                                                                                               │
│  2. **风险相关内容**：                                                                                                                        │
│     - “ITEM 1A. Risk Factors”（第9页）列出了公司面临的主要风险因素。                                                                          │
│     - “ITEM 7A. Quantitative and Qualitative Disclosures about Market Risk”（第49页）披露了市场风险的定量和定性信息。                         │
│     -                                                                                                                                         │
│  公司通过外汇风险管理计划减轻货币波动对经营成果、财务状况和现金流的影响，涉及产品成本、非功能性货币计价的收入、内部公司收入、需求创造费用等   │
│  （见第79页）。                                                                                                                               │
│     - 利率风险方面，截至2023年5月31日，长期美元固定利率债务的本金支付及加权平均利率按预期到期日列示（见第50页表格）。                         │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭───────────────────────────────────────────────────────────── 📋 Task Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Task Completed                                                                                                                               │
│  Name:                                                                                                                                        │
│  在已有检索结果基础上，针对用户问题「文档中与收入、风险相关的主要内容有哪些？」生成最终答案。基于检索内容，不编造；不足则说明。               │
│  Agent:                                                                                                                                       │
│  高级问答助手                                                                                                                                 │
│                                                                                                                                               │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

[CrewAIEventsBus] Warning: Ending event 'crew_kickoff_completed' emitted with empty scope stack. Missing starting event?
╭─────────────────────────────────────────────────────────────── Crew Completion ───────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Crew Execution Completed                                                                                                                     │
│  Name:                                                                                                                                        │
│  crew                                                                                                                                         │
│  ID:                                                                                                                                          │
│  9e26b3a7-b374-48a4-97d4-e5504eb8c496                                                                                                         │
│  Final Output: 文档中与收入、风险相关的主要内容包括：                                                                                         │
│                                                                                                                                               │
│  1. **收入相关内容**：                                                                                                                        │
│     - 在“Note 14 Revenues”（第83页）中详细说明了收入的会计政策和确认方式。                                                                    │
│     -                                                                                                                                         │
│  衍生工具作为现金流量套期保值的一部分，其重分类调整影响收入。例如，外汇远期和期权在2023年有2600万美元的收益从累计其他综合收益重分类至收入（R  │
│  evenues）（见第82页表格）。                                                                                                                  │
│                                                                                                                                               │
│  2. **风险相关内容**：                                                                                                                        │
│     - “ITEM 1A. Risk Factors”（第9页）列出了公司面临的主要风险因素。                                                                          │
│     - “ITEM 7A. Quantitative and Qualitative Disclosures about Market Risk”（第49页）披露了市场风险的定量和定性信息。                         │
│     -                                                                                                                                         │
│  公司通过外汇风险管理计划减轻货币波动对经营成果、财务状况和现金流的影响，涉及产品成本、非功能性货币计价的收入、内部公司收入、需求创造费用等   │
│  （见第79页）。                                                                                                                               │
│     - 利率风险方面，截至2023年5月31日，长期美元固定利率债务的本金支付及加权平均利率按预期到期日列示（见第50页表格）。                         │
│                                                                                                                                               │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

文档中与收入、风险相关的主要内容包括：

1. **收入相关内容**：
   - 在“Note 14 Revenues”（第83页）中详细说明了收入的会计政策和确认方式。
   - 衍生工具作为现金流量套期保值的一部分，其重分类调整影响收入。例如，外汇远期和期权在2023年有2600万美元的收益从累计其他综合收益重分类至收入（Revenues）（见第82页表格）。

2. **风险相关内容**：
   - “ITEM 1A. Risk Factors”（第9页）列出了公司面临的主要风险因素。
   - “ITEM 7A. Quantitative and Qualitative Disclosures about Market Risk”（第49页）披露了市场风险的定量和定性信息。
   - 公司通过外汇风险管理计划减轻货币波动对经营成果、财务状况和现金流的影响，涉及产品成本、非功能性货币计价的收入、内部公司收入、需求创造费用等（见第79页）。
   - 利率风险方面，截至2023年5月31日，长期美元固定利率债务的本金支付及加权平均利率按预期到期日列示（见第50页表格）。
╭─────────────────────────────────────────────────────────────── Tracing Status ────────────────────────────────────────────────────────────────╮
│                                                                                                                                               │
│  Info: Tracing is disabled.                                                                                                                   │
│                                                                                                                                               │
│  To enable tracing, do any one of these:                                                                                                      │
│  • Set tracing=True in your Crew/Flow code                                                                                                    │
│  • Set CREWAI_TRACING_ENABLED=true in your project's .env file                                                                                │
│  • Run: crewai traces enable                                                                                                                  │
│                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
(venv) zyh@U-4H6F3DC4-0159 latest_ai_development %                       


